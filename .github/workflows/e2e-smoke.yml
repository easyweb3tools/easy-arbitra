name: E2E Smoke

on:
  workflow_dispatch:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare env
        run: cp .env.example .env
      - name: Start stack
        run: docker compose up -d postgres backend frontend
      - name: Wait backend
        run: |
          for i in {1..60}; do
            if curl -sf http://localhost:8080/readyz >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "backend not ready"
          docker compose logs backend
          exit 1
      - name: Run API smoke
        run: |
          docker compose exec -T backend sh -lc 'cd /app && DATABASE_HOST=postgres DATABASE_PORT=5432 DATABASE_USER=postgres DATABASE_PASSWORD=postgres DATABASE_DBNAME=easy_arbitra DATABASE_SSLMODE=disable /usr/local/go/bin/go run ./cmd/migrate'
          ./scripts/e2e_api_smoke.sh
      - name: Run UI smoke
        run: ./scripts/e2e_ui_smoke.sh
      - name: Setup Node for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install Playwright deps
        run: |
          cd frontend
          npm ci
          npx playwright install --with-deps chromium
      - name: Run Playwright smoke
        run: |
          cd frontend
          E2E_BASE_URL=http://localhost:3000 npm run test:e2e
      - name: Dump logs on failure
        if: failure()
        run: docker compose logs
      - name: Tear down
        if: always()
        run: docker compose down -v
